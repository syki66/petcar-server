# petcar-server

- picar 제어 서버

|picar|서버|
|:---:|:---:|
|![picar]()|![server]()|

---

## 목적 및 필요성

- 요즈음 반려동물을 키우는 사람이 1000만명을 넘어섬에 따라 많은 문제들이 야기되는데, 특히 1인 가구들의 입양도 굉장히 많이 늘어났음
- 보통 1인가구는 직장인들이 많기에 반려동물은 하루 중 대부분의 시간을 혼자 지내게 됨
- 반려동물은 스트레스를 받아 이상행동을 하거나 다른 문제들이 발생할 수 있음
- 반려동물과 주인이 멀리 떨어져 있는 상황에 문제가 발생했을 경우 주인이 알아차릴 수 있고, 통신을 이용해 직접 놀아주거나, 자동화를 통해서도 놀아줄 수 있도록 원격 장치를 만들게 됨

## 과제 해결방안 및 수행과정

- 멀리서도 움직이면서 반려동물과 통신할 수 있도록 `자동차 형태`의 프로토타입 제작을 계획 (가정에서는 옷, 쓰레기 등 장애물이 많아 6륜 자동차로 계획함)
- 차체 제작은 코드를 이용하여 3D 모델링이 가능한 `openscad`라는 오픈소스 프로그램을 사용하여 설계함 (https://github.com/syki66/3D-modelings/tree/master/pi_car_frame)
- 이때 모터를 가로 방향으로 배치를 하면, 가정용 3D 프린터 X,Y축의 한계인 214mm를 초과하기 때문에, 모터를 `수직 방향으로 재설계`를 진행
- 설계와 실제의 오차 때문에 여기서 생각보다 의외로 많은 시행착오를 거침 (특히 두께에 있어서 단단함의 정도와 시간 및 재료소비의 적절한 지점을 찾기 위해 부분 출력을 진행하면서 `2.4T`의 `두께` 값을 도출함)
- 차체가 완성된 이후, 모터 6개를 수직으로 차체에 연결 및 고정
- 6개 모터들의 출력량이 낮아지지 않도록 모터를 `모터 드라이버`에 `병렬`로 `연결`시킴.
- `라즈베리파이`의 `GPIO`에 `모터 드라이버`, `서보 모터`, `LED` 등 회로를 알맞게 연결하고, 카메라 모듈도 연결 후, 간단히 테스트 코드를 작성하여 모든 부품의 작동을 확인함
- 전력을 많이 소모하기에 리튬 이온 또는 리튬 폴리머 배터리를 사용해야 되는데, 배터리에 대한 지식이 부족해 위험할 수 있어서 보조배터리를 이용하여 기본 전력을 공급했고, 추가로 알칼라인 배터리를 직렬로 연결하여 총 10V 이상의 전압을 공급함
- 라즈베리파이의 python에는 GPIO를 쉽게 제어할 수 있는 라이브러리가 내장되어 있어 python으로 개발하였고, 서버를 구동하기 위해서는 Django 라이브러리와 Flask를 고민하다가 가볍게 구동이 가능한 Flask를 선택함
- `DC Motor`는 `연속 제어 모드` 코드를 클래스로 작성하고, `실시간 제어 모드`는 이를 상속 및 오버라이딩 하여 코드 구성함
- `Servo Motor` on/off 기능도 추가하고, RGB LED를 제어하여 모든 색상을 출력할 수 있도록 코드 구성
- `카메라` 스트리밍 코드도 추가하여 `실시간`으로 `영상`을 `송출`하도록 구성함
- `라우팅` 처리를 했고, 특정 `주소`를 `호출`하게 되면 특정 `기능`이 `작동`하는 방식으로 설계
- 라우터에서 `포트 포워딩` 설정을 통해 인터넷이 있는 `모든 곳`에서 서버에 `접속`이 `가능`하도록 설계
- 서버 완료 이후, 밖에서 간편하게 스마트폰으로 제어 가능하도록 `모바일 앱`으로 제작하기로 했고, 안드로이드, 아이폰 모두 제어 가능하도록 `React Native`를 이용하여 제작함
- iOS의 경우, 빌드 시 MacOS의 Xcode가 필요한데, 장비가 없어서 `Expo` 라이브러리를 활용해 윈도우 OS에서 코드를 작성하고 앱을 구현함
- 앱은 카메라 영상을 수신하여 볼 수 있고, 움직이기 위한 제어 버튼, 서버모터 제어 버튼과 RGB LED 제어 버튼을 만들어 UI를 한 화면에 직관적으로 구성함

## 기대효과

- 혼자 남겨진 반려동물의 스트레스를 완화시켜 주고, 주인의 걱정과 염려도 낮춰줄 것으로 기대함

---

## Feature

- DC모터 GPIO 제어
- 서보모터 GPIO 제어
- 카메라 제어
- LED 센서 제어

---

## Usage

- 로컬 네트워크를 이용하거나, [외부 접속은 포트포워딩 이용하기](https://syki66.github.io/blog/2020/11/06/port-forwading.html)
- [라즈베리파이 부팅 후, 자동으로 서버 실행하기](https://syki66.github.io/blog/2020/09/19/crontab.html)

---

## Change Log

- [CHANGELOG.MD](https://github.com/syki66/picar-server/blob/master/CHANGELOG.MD)

---

## Run

```
python app.py
```

---
